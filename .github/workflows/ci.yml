name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install linting tools
        run: |
          pip install flake8 black isort
      
      - name: Lint coordinator
        run: |
          cd coordinator
          flake8 main.py --max-line-length=100 --exclude=__pycache__
          black --check main.py
          isort --check-only main.py
      
      - name: Lint runner
        run: |
          cd runner
          flake8 main.py --max-line-length=100 --exclude=__pycache__
          black --check main.py
          isort --check-only main.py

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build coordinator image
        run: |
          docker build -t coordinator:test ./coordinator
      
      - name: Build runner image
        run: |
          docker build -t runner:test ./runner

  test:
    name: Test Platform
    runs-on: ubuntu-latest
    needs: [lint, build]
    steps:
      - uses: actions/checkout@v4
      
      - name: Start services
        run: |
          docker-compose up -d
      
      - name: Wait for services to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:8000/health && curl -f http://localhost:8080/health; do sleep 2; done'
      
      - name: Test job submission
        run: |
          # Submit a test job
          JOB_RESPONSE=$(curl -s -X POST http://localhost:8000/jobs \
            -H "Content-Type: application/json" \
            -d '{"command": "echo hello world", "timeout": 10}')
          
          echo "Job response: $JOB_RESPONSE"
          
          # Extract job_id (basic parsing)
          JOB_ID=$(echo $JOB_RESPONSE | grep -o '"job_id":"[^"]*' | cut -d'"' -f4)
          
          echo "Job ID: $JOB_ID"
          
          # Wait for job to complete
          sleep 5
          
          # Check job status
          STATUS=$(curl -s http://localhost:8000/jobs/$JOB_ID | grep -o '"status":"[^"]*' | cut -d'"' -f4)
          
          echo "Job status: $STATUS"
          
          if [ "$STATUS" != "completed" ] && [ "$STATUS" != "failed" ]; then
            echo "Job did not complete in time"
            exit 1
          fi
      
      - name: Test metrics endpoint
        run: |
          METRICS=$(curl -s http://localhost:8000/metrics)
          echo "$METRICS"
          
          if ! echo "$METRICS" | grep -q "jobs_total"; then
            echo "Metrics endpoint not working correctly"
            exit 1
          fi
      
      - name: Test runner metrics
        run: |
          METRICS=$(curl -s http://localhost:8080/metrics)
          echo "$METRICS"
          
          if ! echo "$METRICS" | grep -q "executions_total"; then
            echo "Runner metrics endpoint not working correctly"
            exit 1
          fi
      
      - name: Cleanup
        if: always()
        run: |
          docker-compose down
